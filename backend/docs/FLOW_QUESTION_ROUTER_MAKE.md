# Flow: แยกประเภทคำถาม (Make / OpenClaw) กับแชท

เอกสารนี้อธิบายลอจิกตั้งแต่ผู้ใช้ส่งคำถาม → ใช้ Make คัดกรอง path → ตอบหรือถามย้ำ

---

## เงื่อนไขว่าเมื่อไหร่จะใช้ Make

- ใน `.env` ต้องมี `USE_MAKE_FOR_ROUTER=true` และ `MAKE_WEBHOOK_URL=...`
- Backend จะเข้า "flow routing" เมื่อ **OpenClaw เปิด** หรือ **Make เปิด** (อย่างน้อยหนึ่งอย่าง)
- ถ้า Make เปิด → `QuestionRouterService.RouteQuestion()` จะส่งไปที่ **Make** แทน OpenClaw

---

## Flow ทั้งหมด (ขั้นตอนย่อ)

```
ผู้ใช้ส่งคำถาม (อาจมี preferredPath ถ้าเคยเลือกไปแล้ว)
        │
        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 1. สร้าง embedding ของคำถาม (ไว้ใช้กับ vector DB ถ้า fallback)   │
└─────────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. ใช้ routing ไหม? (OpenClaw.Enabled หรือ Make เปิด)            │
│    ไม่ → ไปขั้น 6 (vector DB)                                    │
│    ใช่ → เรียก RouteQuestion(คำถาม)                              │
└─────────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. RouteQuestion (ใน backend)                                    │
│    - ดึงรายการ wiki ทั้งหมด: ListMarkdown() → path + title        │
│    - ถ้าใช้ Make: POST ไป MAKE_WEBHOOK_URL                       │
│      body: { "question": "...", "documents": [{path, title},...] }│
│    - Make รัน scenario → เรียก Ollama → ได้ JSON                 │
│    - Make ตอบกลับ: { "is_ambiguous", "candidates": [{path,...}] }│
│    - Backend ได้ res.Candidates (และ res.IsAmbiguous)             │
└─────────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 4. มี candidates ไหม?                                            │
│    ไม่ (error หรือว่าง) → ไปขั้น 6 (vector DB)                   │
│    ใช่ → ต่อขั้น 5                                                │
└─────────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────┐
│ 5. ลำดับการตัดสินใจ (ใช้ผลจาก Make)                              │
│                                                                   │
│  5.1 ผู้ใช้ส่ง preferredPath มาไหม? (เคยเลือก path แล้ว)          │
│      ใช่ → อ่าน wiki ตรง path นั้น → ส่งให้ Ollama ตอบ → ส่งคำตอบ │
│            กลับไปเลย (จบ)                                         │
│                                                                   │
│  5.2 มี candidates มากกว่า 1 ไหม? (กำกวม)                         │
│      ใช่ → คืน needDisambiguation: true + options (รายการ path   │
│            ให้ผู้ใช้เลือก) หน้าบ้านแสดงปุ่มให้กดเลือก (จบ)        │
│                                                                   │
│  5.3 ไม่กำกวม (หรือเหลือแค่ 1 candidate)                          │
│      → นำ top 1–3 path ไปอ่านเนื้อหา wiki                         │
│      → ต่อเนื้อหาเป็น context → ส่งให้ Ollama สร้างคำตอบ          │
│      → คืน answer + sources (จบ)                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ 6. Fallback: ใช้ vector DB (ค้นจาก embedding + path filter)      │
│    ถ้า routing ไม่ถูกเรียก / ล้มเหลว / ไม่มี candidates           │
└─────────────────────────────────────────────────────────────────┘
```

---

## สรุป input/output ของ Make

| ฝั่ง | ส่งไป Make | ได้กลับจาก Make |
|------|------------|------------------|
| Backend → Make | `question` (string), `documents` (array ของ `{path, title}`) | `is_ambiguous` (bool), `candidates` (array ของ `{path, reason?, score?}`) |
| หน้าที่ Make | รับจาก webhook → สร้าง prompt → เรียก Ollama → ได้ข้อความ JSON | โมดูล Respond to Webhook ส่ง JSON กลับไปที่ backend |

---

## ตัวอย่างคำถามที่เหมาะกับ flow นี้

- **คำถามเฉพาะ:** 「AP Invoice คืออะไร」 → มักได้ 1 candidate → อ่าน wiki path นั้น → ตอบเลย
- **คำถามกว้าง:** 「อธิบาย AP กับ AR」 → อาจได้หลาย candidates → ระบบถามย้ำให้เลือก path ก่อน
- **หลังเลือก path:** ผู้ใช้กดเลือก "AP Invoice" → หน้าบ้านส่งคำถามเดิม + `preferredPath: "carmen_cloud/ap-invoice.md"` → backend อ่าน path นั้นแล้วตอบเลย
